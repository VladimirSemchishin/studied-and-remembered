### Основная информация о виртуальных машинах

ВМ - аналог физического сервера в инфраструктуре

> По сути, компьютер внутри компьютера, изолированный от операционной системы, в которой запущен.

Внутри ВМ работает ОС с прикладным ПО, например с базой данных.  Для функционирования ей нужны:

- ядра процессора
- оперативная память
- диски

> Которые выделяются с сервера (из любой из 3 зон доступности)
>

Чтобы установить, настроить или обновить приложение, можно подключиться в ВМ удаленно.

### Создание виртуальной машины и подключение к ней.

Создаю в интерфейсе Яндекса ВМ по алгоритму из [урока 3](https://practicum.yandex.ru/trainer/ycloud/lesson/467fb1f2-7eb4-421c-a33c-117e1cf86b66/)

**Создание SSH ключей**

1. Запустите терминал в Linux/macOS, либо утилиту `cmd.exe` или `powershell.exe` в Windows 10/11 и создайте пару ключей с помощью команды ssh-keygen:  
   `ssh-keygen -t ed25519`

   1. После выполнения команды указать имена файлов, куда сохранятся ключи 
      *(имя файла пишется в том случае, если в скрытой папке .ssh ,которую можно найти по пути ~/.ssh/  ,уже есть созданная папка с этим именем, иначе они сохранятся хуй знает куда и ничего работать не будет)*

2. Введите пароль для закрытого ключа 
   *(я написал education1)*

   > По умолчанию используется имя `id_ed25519`, ключи создаются в папке `~/.ssh` текущего пользователя.
   >
   > Открытый ключ сохранится в файле `<имя_ключа>.pub`. Содержимое этого файла вставляется в поле **SSH-ключ** на странице создания ВМ.

Дальше по алгоритму из [урока 3](https://practicum.yandex.ru/trainer/ycloud/lesson/467fb1f2-7eb4-421c-a33c-117e1cf86b66/)  (с 10 шага)

**Удаленное подключение к ВМ**

Подключение к ВМ, для этого нужно:

- логин пользователя
- публичный IP-адрес ВМ

Для подключения к запущенной ВМ (статус RANNING) по протоколу SSH, используют утилиту `ssh` 

1. В терминале необходимо выполнить команду: 
   
   `ssh <имя_пользователя>@<публичный_IP-адрес_ВМ>`
   
2. Если несколько ключей: 
   `ssh -i <путь_к_ключу/имя_файла_ключа> <имя_пользователя>@<публичный_IP-адрес_ВМ>` 
   (при первом подключении может появиться предупреждение, нужно ввести yes)
   
3. Установить обновления: 

   `sudo apt-get update`
   `sudo apt-get upgrade`

### Последовательный порт и серийная консоль 

Каждая запущенная ВМ создает порт ввода-вывода `COM1` , к которому можно подключиться.

> Если в ВМ произошел сбой, чтобы выяснить причину необходимо посмотреть журнал системных сообщений, если нет входа в ВМ по SSH или демон sshd (для Linux) не работает, нужно подключиться к **последовательному порту COM1 ВМ** и посмотреть инф. которая туда направляется.

Путь конкретно в моем акк:

 [Compute Cloud](https://console.cloud.yandex.ru/folders/b1gd4d7843kr3km8urvc/compute)/[Виртуальные машины](https://console.cloud.yandex.ru/folders/b1gd4d7843kr3km8urvc/compute/instances)/education1

и в меню слева выбрать последовательный порт.

Можно подключиться к порту `COM1` ВМ Linux или порту `COM2` ВМ Windows, чтобы вводить данные и администрировать ВМ. Эта функция называется **серийная консоль**

**Риски для безопасности:**

- вкл серийную консоль только по необходимости
- давать доступ только узкому кругу людей
- стойкий пароль для доступа к ВМ
- после работы с серийной консолью отключать доступ к ней в ВМ

### Получить доступ к серийной консоли

> Работа серийной консоли зависит от настроек ОС. Yandex Compute Cloud обеспечивает связь между пользователем и COM-портом, но не гарантирует стабильность работы консоли со стороны ОП системы ВМ 

Доступ к серийной консоли ВМ с ОС на базе Linux, способы:

-  с другого ПК по протоколу SSH
- через консоль управления Yandex Cloud
- с помощью интерфейса командной строки Yandex Cloud CLI

Вход по протоколу SSH:

1. Подключиться по протоколу SSH (точно так-же как и подключались к ВМ ранее из урока 3)

2. Установить пароль к текущему  пользователю утилитой `passwd` в привилегированном режиме (через `sudo`):

   `sudo passwd <имя_пользователя>`

   (дважды нужно ввести один пароль, *я ввел education1*)

3. Для доступа к консоли ВМ необходим ее идентификатор (ID), в списке ВМ он указан в правом столбце

4. Использовать в запросе идентификатор ВМ и имя (логин) созданного в ней пользователя:

   `ssh -t -p 9600 -o IdentitiesOnly=yes -i ~/.ssh/<имя закрытого ключа> <ID виртуальной машины>.<имя пользователя>@serialssh.cloud.yandex.net`

   > 'эта команда вводится с консоли личного пк, то есть на котором сгенерированы ssh ключи, то есть имя закрытого ключа - это имя файла где закрытый ssh ключ (он в скрытой паке ~/.shh/ , id виртуальной машины - это ее идентификатор (не публичный и не закрытый IP!!!!), а имя пользователя это имя самой ВМ)

5. Ввести ранее установленный пароль

6. Для отключения можно:

   - нажать `Enter`, затем ввести `~.`
   - Ctrl+D

### Прерываемые машины и уровни производительности

**Уровень производительности - vCPU** - определяет доступную ВМ долю вычислительного времени физических ядер:

- 100% - непрерывный доступ к вычислительной мощности физических ядер
- меньше 100% - имеют доступ к вычислительной мощности  как минимум на протяжении указанного процента от единицы времени

> 100% для тех высоко производительных проектов, которые чувствительны к задержкам 

### Сервис метаданных и cloud-init

В Compute Cloud с каждой ВМ связаны метаданные.

Метаданные - это:

- идентификатор
- название и описание ВМ
- список подключенных к ней дисков и сетевых интерфейсов
- привязанные к ВМ сервисные аккаунты

так же можно определить дополнительные метаданные и указывать их, когда задается или изменяется ВМ.

Получить метаданные можно изнутри ВМ через сервис метаданных по адресу:  [http://169.254.169.254](http://169.254.169.254/)

Сервис возвращает метаданные в 2 форматах: Google Compute Engine или Amazon EC2.

> В ВМ на базе Linux для работы с метаданными, как правило, используется агент [cloud-init](https://cloud-init.io/), в машинах с Windows — [Cloudbase-Init](https://cloudbase.it/cloudbase-init/). Но вы можете отправить запрос в сервис метаданных и самостоятельно — с помощью любого HTTP-клиента.

Передать метаданные можно при создании или изменении ВМ, обычно это делается через консольную утилиту Yandex Cloud CLI. 

Указывайте метаданные в одном из 3 параметров:

- `--metadata` принимает список пар "ключ=значение", разделенных запятой, пример: -`-metadata foo1=bar,foo2=baz`
- `--metadata-from-file` читает метаданные из файла, например: `-metadata-from-file key=path/to/file` (удобно если нужно передать длинные метаданные)
- `--ssh-key` специальный тип метаданных для хранения публичного ключа (доступен тока на линуксе, его читает cloud-init)

> Чтобы получить метаданные ВМ от Yandex Cloud, вы можете использовать интерфейс командной строки Yandex Cloud (CLI) или API. Пошаговое руководство по использованию CLI для решения этой задачи приведено в [документации](https://cloud.yandex.ru/docs/compute/operations/vm-info/get-info). 
