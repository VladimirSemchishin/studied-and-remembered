# Описание и особенности DataLens

Собирать, структурировать и надёжно хранить информацию — это не самоцель. Данные — лишь сырьё для анализа, после которого принимаются решения.

Анализ информации, особенно если её много, требует усилий и времени. Этот процесс можно облегчить и ускорить с помощью визуализации данных. График или диаграмма позволят заметить тенденцию, сформулировать гипотезу о причинно-следственных связях или увидеть за цифрами важный факт.

## Что такое DataLens

DataLens — сервис Yandex.Cloud для визуализации и анализа данных. Он позволяет создавать **чарты** — диаграммы и графики, а также строить **дашборды** — страницы с инфографикой. Всё, что для этого нужно, — взять источник данных, создать **датасет** и настроить его визуальное представление.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/43/01.png)

> *[Пример дашборда](https://datalens.yandex/9fms9uae7ip02/) торговой сети. На чартах находятся ключевые показатели продаж, динамика продаж по категориям товаров и по магазинам, число заявок по районам города и т. д. Фактически дашборд представляет собой аналитическую панель для быстрого управления торговой сетью*

## Для чего нужен DataLens

С помощью DataLens можно быстро проанализировать данные, взятые напрямую из источника. Например, бизнес-показатели — количество звонков и заказов — или данные из сервисов аналитики Яндекс Метрика и AppMetriсa. Анализ помогает сформулировать гипотезы для детальной проработки или увидеть, как развивается ситуация.

Настроив дашборд, вы получите инструмент для регулярного мониторинга работы сайта, приложения или всего продукта. Например, с помощью дашборда на изображении выше сотрудники торговой сети видят, успешны ли продажи, какие товары пользуются спросом, в каких районах дела идут нормально, а где сеть не особенно популярна. Хорошо построенный дашборд помогает быстрее и лучше понять, что происходит, и вовремя принять решения.

С помощью DataLens вы можете наглядно показать результаты исследования коллегам, руководству, бизнес-партнёрам, а если захотите — то и всему интернету. [Посмотрите](https://datalens.yandex/7o7is1q6ikh23), например, как на публичном дашборде представлена информация о пандемии COVID-19. Вы можете легко понять, как развивается ситуация с коронавирусом в мире, в отдельных странах или регионах России.

## Ключевые особенности DataLens

Работа с DataLens не требует умения писать код или продвинутых технических знаний для развёртывания и администрирования инфраструктуры. Чтобы создавать чарты и дашборды, не нужна специальная подготовка, и в этом сила DataLens.

Источником данных для визуализаций могут быть базы данных (облачные и локальные), плоские файлы (простые текстовые файлы с данными, например csv), Яндекс Метрика, AppMetrica и другие сервисы. DataLens может работать с источником данных напрямую или кешировать их в кластере ClickHouse, чтобы снять нагрузку с источника и обеспечить более быстрый отклик. На дашборде или графике можно комбинировать данные из разных источников.

DataLens позволяет настраивать права доступа к объектам, в том числе на уровне строк с данными. То есть, например, можно открыть дашборд для нескольких пользователей, но каждый из них увидит данные, доступные только для него. Например, сотрудники регионального отделения компании используют дашборд с бизнес-показателями, отражающими работу своего отделения, а центральный офис видит полную картину: и по каждому филиалу, и по компании в целом.

DataLens находится в экосистеме Яндекса и интегрирован с другими сервисами. Например, он из коробки работает с ClickHouse и имеет встроенные функции для работы с геоданными Яндекс Карт, что позволяет отображать данные прямо на карте.

В [маркетплейсе DataLens](https://cloud.yandex.ru/marketplace?tab=datalens) есть дополнительные коннекторы для источников данных (например для подключения к 1С) и внешние датасеты (например данные Яндекс Погоды).

Ещё один немаловажный момент. В отличие от многих BI-инструментов (инструментов для бизнес-аналитики) DataLens полностью бесплатный.

Обсудить технические вопросы или поделиться опытом использования DataLens вы можете в Telegram-чате [сообщества визуализаторов данных Yandex DataLens](https://t.me/YandexDataLens).

# Обзор DataLens, модель данных

Работа с данными в DataLens происходит так: мы подключаем источник данных, создаём из него датасет, а на основе датасета делаем чарты, из которых составляем дашборд.

В качестве **источника данных** DataLens использует БД (ClickHouse, MySQL, PostgreSQL, SQL Server, Oracle Database, YDB, Greenplum), которые могут находиться и в облаке, и вне него, а также csv-файлы, сервисы Google Sheets, Яндекс Метрика и AppMetrica. Подойдут и другие источники, если в [маркетплейсе](https://cloud.yandex.ru/marketplace?tab=datalens) для них есть коннекторы. Список поддерживаемых источников постоянно пополняется.

Для доступа к источнику данных понадобится **подключение**. Оно содержит информацию о параметрах доступа. Например, IP-адрес хоста БД или номер порта.

Из источника данных сервис создаёт **датасет**: набор данных и их описание.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/01.png)

> *Так выглядит датасет со статистикой заболеваемости коронавирусом в России*

Датасет может работать в двух режимах. В режиме **прямого доступа** DataLens направляет запросы к источнику данных каждый раз, когда создаёт визуализацию. В режиме **материализации** DataLens один раз загружает все данные из источника в свою БД и потом на её основе строит чарты. Материализацию используют, если не хотят нагружать исходную БД.

На основе данных из одного или нескольких датасетов создают **чарты**: диаграммы, графики, картограммы и таблицы. Чарты позволяют быстро оценить данные или проверить гипотезы. Подробности обо всех типах чартов DataLens вы найдёте в [документации](https://cloud.yandex.ru/docs/datalens/concepts/chart#chart-types).

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/02.png)

> *Столбчатая диаграмма с общим числом случаев заболевания коронавирусом по федеральным округам*

Чарты с данными можно добавить на **дашборд**. Как правило, дашборд состоит из чартов, заголовков, поясняющих надписей и селекторов, с помощью которых к данным применяют фильтры (например, выбирают диапазон дат или категорию товара).

На дашборде чарт помещается в отдельный блок — **виджет**. Вы можете передвигать виджет, изменять его размер, а также название чарта в виджете.

Вот так выглядит готовый дашборд.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/03.png)

*Дашборд с информацией о ключевых показателях работы торговой сети*

[Откройте этот дашборд](https://datalens.yandex/7zdipxsaaxds4) и посмотрите, как он позволяет анализировать данные. А на следующем уроке вы создадите дашборд сами.

**Модель данных**

DataLens берёт данные из одной или нескольких таблиц источника. Если таблиц несколько, то их связывают, указав одинаковые поля (столбцы или строки — в зависимости от источника). Сервис может связать таблицы и автоматически по первому совпадению имени и типа данных этих полей.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/04.png)

Выше показано, как DataLens загружает БД торговой сети, состоящую из пяти таблиц. Между таблицами установлены связи: таблица с данными о продажах товаров связывается с таблицей с данными о магазинах сети по полю ShopID.

Из данных источника DataLens формирует датасет. Датасет состоит из полей двух типов: измерение и показатель.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/05.png)

**Поля-измерения** содержат качественные характеристики (например название магазина, товара, дата покупки). В интерфейсе эти поля зелёные.

**Поля-показатели** содержат количество, т. е. это числовые значения (например стоимость заказа, цена товара). В интерфейсе эти поля синие.

На чартах и дашбордах по значениям измерений агрегируются значения показателей (например по дате суммируется стоимость заказов в этот день).

Для полей-показателей обязательно определяйте функцию агрегации (например, количество, сумма, среднее) Для полей-измерений функция агрегации не используется.

Остановимся на типах полей ещё раз: это очень важно! От того, как вы определите тип поля — измерение это или показатель, — зависит логика генерации запроса в источник данных и результат их визуализации.

Измерения (дата, название продукта, регион, тип доставки и т. д.) используются для группировки и формирования разрезов в данных и отчётах. Показатели — это агрегируемые значения, метрики (выручка, число сессий, число заказов и т. д.). Их анализируют в разрезе измерений.

В зависимости от того, что мы хотим отобразить на чарте, одно и то же поле может быть и измерением, и показателем. Например, если поле «Клиент»:

- измерение — то используем его для группировки показателя «Выручка» и получим отчёт с выручкой по клиентам;
- показатель — то применим к нему правило агрегации `COUNTD` (Count Distinсt, количество уникальных значений) и построим отчёт, группирующий клиентов по регионам, т. е. показывающий, сколько в каждом регионе уникальных клиентов.

Если вы планируете использовать поле в качестве и измерения, и показателя, то лучше продублировать его на уровне датасета и сделать два разных поля.

На графике элементы поля-измерения располагаются по оси X, а агрегированные значения поля-показателя — по оси Y.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/44/06.png)

DataLens также позволяет создавать **вычисляемые поля**. Это можно сделать на уровне датасета (тогда они будут доступны во всех чартах) или на уровне чарта (поля будут видны только в нём). Вычисляемое поле — это дополнительное поле данных, его значения рассчитываются по формуле. Формулы представляют собой выражения, в которых используются функции, имена полей датасета и константы.

В DataLens более 150 функций, позволяющих выполнять операции с данными: агрегатные, логические, строковые, преобразования типов данных, работы с временными рядами. Например, функция `MONTH(datetime)` возвращает номер месяца в году для указанной даты:

`MONTH(#2019-01-23#) = 1`

Справочник функций приведён в [документации](https://cloud.yandex.ru/docs/datalens/function-ref/all).

# оздание датасетов, чартов и дашбордов

Приступим к практике. На этом уроке вы научитесь создавать чарты и дашборды. Мы пройдём по всей цепочке сущностей DataLens начиная с источника данных.

Изучая ClickHouse, мы анализировали данные о погоде с помощью SQL-запросов. Давайте посмотрим на примере того же самого набора данных, как с помощью DataLens быстро и наглядно показать отличия климата в Москве и Санкт-Петербурге.

## Источник данных

ClickHouse и DataLens интегрированы друг с другом, поэтому подключение DataLens к ClickHouse можно настроить всего за пару кликов.

В консоли управления запустите кластер ClickHouse, в котором развёрнута БД с таблицей `Weather`, созданной вами ранее. Перейдите на страницу кластера, на панели слева выберите **DataLens**.

## Подключение

Нажмите кнопку **Создать подключение.** В открывшемся диалоговом окне вы увидите, что кластер ClickHouse, из которого мы возьмём данные для анализа, имя хоста и имя пользователя БД уже указаны.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/01.png)

Вам осталось только дать имя подключению в пустом поле вверху, ввести пароль к БД, нажать кнопку **Проверить подключение** и убедиться, что всё в порядке, а потом — кнопку **Создать**.

## Датасет

После того как подключение будет создано, DataLens выведет на панели слева таблицы из БД и предложит создать датасет. Наш датасет будет состоять из одной таблицы: `db1.Weather`. Перетащите её на центральную панель, и внизу откроется предпросмотр данных.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/02.png)

Нажмите кнопку **Сохранить** и задайте имя датасета.

Подготовим данные. Это важная часть аналитической работы, и её не стоит пропускать. Прежде всего укажем имена полей на русском языке. Перейдите на вкладку **Поля** и переименуйте их:

- LocalDateTime → Дата и время
- LocalDate → Дата
- Month → Месяц
- Day → День
- TempC → Температура
- Pressure → Давление
- RelHumidity → Влажность
- Тип WindSpeed10MinAvg → Скорость ветра
- VisibilityKm → Видимость
- City → Город

Поля **Дата и время, Дата, Месяц, День, Город** будут полями-измерениями, а **Температура, Давление, Влажность, Скорость ветра, Видимость** — полями-показателями. Зададим для показателей тип агрегации **Среднее**.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/03.png)

## Чарты

Приступим к созданию первого чарта. Нажмите кнопку **Создать чарт.** Выберите тип чарта **Линейная диаграмма** и перетащите **Дата** в раздел **X** , а **Температура** — в раздел **Y**.

![image](https://pictures.s3.yandex.net/resources/273-04_1625861840.gif)

На этом примере видно, что средства визуализации иногда помогают быстро проверить качество датасета: есть ли в нём пропущенные или странные, выбивающиеся из общей тенденции данные.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/04.png)

В нашем случае можно сделать вывод о том, что в датасете не хватает данных примерно с середины 2015-го по середину 2016-го.

Разделим показатели температуры для двух городов. Для этого перетащим **Город** в раздел **Цвета**. Кроме того, округлим значения поля **Дата** до месяцев, чтобы лучше увидеть, как различаются данные для Москвы и Санкт-Петербурга. Для этого слева от поля **Дата** нажмите зелёный значок календаря и в разделе **Группировка** выберите округление по месяцам.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/05.png)

Из этого графика уже можно делать выводы. В целом температура в Москве выше, чем в Санкт-Петербурге. Летом примерно на 5 градусов, зимой — на 1−2 градуса.

Сохраните чарт, чтобы затем использовать его для дашборда.

Чтобы окончательно разобраться с температурой, построим ещё один чарт — **Столбчатую диаграмму** — и сравним среднегодовую температуру. Выберите тип диаграммы. Добавьте поле **Город** в раздел **X**, чтобы разделить отображение значений температуры. Также для поля **Дата** выберите группировку по годам.

Кроме того, для чарта понадобится задать фильтр по датам. Поскольку мы сравниваем среднегодовые значения, неполные данные за 2009 и 2019 годы отбросим. В разделе **Фильтры** нажмите **+** и выберите поле **Дата.**

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/06.png)

Для этого чарта мы возьмём только данные из диапазона с начала 2010-го по конец 2018-го. Нажмите кнопку **Применить фильтр** и сохраните чарт.

Сделайте сами два таких же чарта с данными о скорости ветра: линейную диаграмму со среднемесячными значениями скорости ветра в городах и столбчатую диаграмму со среднегодовыми значениями.

Теперь у нас достаточно чартов для информативного дашборда.

## Дашборд

На панели слева выберите **Дашборды** и нажмите кнопку **Создать дашборд.** Введите название дашборда и нажмите **Создать**.

Если в каталоге это первый дашборд — он откроется сразу после создания. Если в каталоге есть другие дашборды, вы увидите список. В этом случае выберите из списка только что созданный дашборд.

Теперь добавим созданные нами чарты на дашборд. Нажмите **Добавить** и в выпадающем списке выберите **Чарт**. Поочерёдно выбирайте из списка и добавляйте чарты.

В результате на дашборде появятся четыре виджета с чартами. Меняйте размеры и положение виджетов для лучшей визуализации.

Осталось лишь несколько последних штрихов. В том же пункте меню **Добавить** создадим пару заголовков и селектор по датам. В правом верхнем углу каждого виджета нажмите значок шестерёнки, чтобы изменить названия.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/07.png)

![image](https://pictures.s3.yandex.net/resources/7_7_1626254910.png)

Сохраним дашборд. У вас могло получиться примерно так:

![image](https://pictures.s3.yandex.net/resources/8_4_1626254937.png)

То, какие чарты сделать и как их разместить на дашборде, бывает понятно не сразу. Рассмотрите несколько вариантов, когда строите дашборд, чтобы разобраться, какая именно визуализация лучше помогает ответить на вопросы.

В маркетплейсе DataLens вы найдёте ещё один [дашборд с погодой](https://datalens.yandex.ru/marketplace/f2e5ruuqu251tbsn1oet). Он хорошо демонстрирует возможности визуализации данных этого сервиса.

![image](https://pictures.s3.yandex.net/resources/9_2_1626254958.png)

Чтобы открыть публичный доступ к дашборду, справа от его названия нажмите **···** и выберите **Публичный доступ**. Скопируйте ссылку. По ней дашборд будет доступен всем, с любых устройств и без аутентификации.

![image](https://code.s3.yandex.net/Cloud/CloudEngineer/DB/45/11.png)